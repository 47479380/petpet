// modified from https://github.com/buzzfeed/libgif-js
var bitsToNum=function(e){return e.reduce(function(e,t){return 2*e+t},0)},byteToBitArr=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},Stream=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},lzwDecode=function(e,t){for(var n,r,a=0,i=[],o=1<<e,l=o+1,s=e+1,c=[];;){if(r=n,(n=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(a>>3)&1<<(7&a)&&(n|=1<<r),a++;return n}(s))===o){!function(){c=[],s=e+1;for(var t=0;t<o;t++)c[t]=[t];c[o]=[],c[l]=null}();continue}if(n===l)break;if(n<c.length)r!==o&&c.push(c[r].concat(c[n][0]));else{if(n!==c.length)throw Error("Invalid LZW code.");c.push(c[r].concat(c[r][0]))}i.push.apply(i,c[n]),c.length===1<<s&&s<12&&s++}return i},parseGIF=function(e,t){t||(t={});var n=function(t){for(var n=[],r=0;r<t;r++)n.push(e.readBytes(3));return n},r=function(){var t,n;n="";do t=e.readByte(),n+=e.read(t);while(0!==t);return n},a=function(n){var a,i,o,l,s,c,d,h;switch(n.label=e.readByte(),n.label){case 249:n.extType="gce",a=n,e.readByte(),i=byteToBitArr(e.readByte()),a.reserved=i.splice(0,3),a.disposalMethod=bitsToNum(i.splice(0,3)),a.userInput=i.shift(),a.transparencyGiven=i.shift(),a.delayTime=e.readUnsigned(),a.transparencyIndex=e.readByte(),a.terminator=e.readByte(),t.gce&&t.gce(a);break;case 254:n.extType="com",(o=n).comment=r(),t.com&&t.com(o);break;case 1:n.extType="pte",l=n,e.readByte(),l.ptHeader=e.readBytes(12),l.ptData=r(),t.pte&&t.pte(l);break;case 255:n.extType="app",c=n,(e.readByte(),c.identifier=e.read(8),c.authCode=e.read(3),"NETSCAPE"===c.identifier)?(d=c,e.readByte(),d.unknown=e.readByte(),d.iterations=e.readUnsigned(),d.terminator=e.readByte(),t.app&&t.app.NETSCAPE&&t.app.NETSCAPE(d)):((h=c).appData=r(),t.app&&t.app[h.identifier]&&t.app[h.identifier](h));break;default:n.extType="unknown",(s=n).data=r(),t.unknown&&t.unknown(s)}},i=function(a){a.leftPos=e.readUnsigned(),a.topPos=e.readUnsigned(),a.width=e.readUnsigned(),a.height=e.readUnsigned();var i=byteToBitArr(e.readByte());a.lctFlag=i.shift(),a.interlaced=i.shift(),a.sorted=i.shift(),a.reserved=i.splice(0,2),a.lctSize=bitsToNum(i.splice(0,3)),a.lctFlag&&(a.lct=n(1<<a.lctSize+1)),a.lzwMinCodeSize=e.readByte();var o=r();a.pixels=lzwDecode(a.lzwMinCodeSize,o),a.interlaced&&(a.pixels=function(e,t){for(var n=Array(e.length),r=e.length/t,a=[0,4,2,1],i=[8,8,4,2],o=0,l=0;l<4;l++)for(var s=a[l];s<r;s+=i[l])(function(r,a){var i=e.slice(a*t,(a+1)*t);n.splice.apply(n,[r*t,t].concat(i))})(s,o),o++;return n}(a.pixels,a.width)),t.img&&t.img(a)},o=function(){var n={};switch(n.sentinel=e.readByte(),String.fromCharCode(n.sentinel)){case"!":n.type="ext",a(n);break;case",":n.type="img",i(n);break;case";":n.type="eof",t.eof&&t.eof(n);break;default:throw Error("Unknown block: 0x"+n.sentinel.toString(16))}"eof"!==n.type&&setTimeout(o,0)};(function(){var r={};if(r.sig=e.read(3),r.ver=e.read(3),"GIF"!==r.sig)throw Error("Not a GIF file.");r.width=e.readUnsigned(),r.height=e.readUnsigned();var a=byteToBitArr(e.readByte());r.gctFlag=a.shift(),r.colorRes=bitsToNum(a.splice(0,3)),r.sorted=a.shift(),r.gctSize=bitsToNum(a.splice(0,3)),r.bgColor=e.readByte(),r.pixelAspectRatio=e.readByte(),r.gctFlag&&(r.gct=n(1<<r.gctSize+1)),t.hdr&&t.hdr(r)})(),setTimeout(o,0)};export const SuperGif=function(e){var t,n,r,a,i,o,l={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var s in e)l[s]=e[s];l.vp_w&&l.vp_h&&(l.is_vp=!0);var c=null,d=!1,h=null,u=null,p=null,f=null,g=null,y=null,$=null,w=!0,v=!1,m=[],_=[],x=l.gif;void 0===l.auto_play&&(l.auto_play=!x.getAttribute("rel:auto_play")||"1"==x.getAttribute("rel:auto_play"));var b,T,B,C,P,S,k,A,E,F=l.hasOwnProperty("on_end")?l.on_end:null,I=l.hasOwnProperty("loop_delay")?l.loop_delay:0,N=l.hasOwnProperty("loop_mode")?l.loop_mode:"auto",z=!l.hasOwnProperty("draw_while_loading")||l.draw_while_loading,O=!!z&&(!l.hasOwnProperty("show_progress_bar")||l.show_progress_bar),U=l.hasOwnProperty("progressbar_height")?l.progressbar_height:25,D=l.hasOwnProperty("progressbar_background_color")?l.progressbar_background_color:"rgba(255,255,255,0.4)",G=l.hasOwnProperty("progressbar_foreground_color")?l.progressbar_foreground_color:"rgba(255,0,22,.8)",R=function(){h=null,u=null,g=p,p=null,y=null},M=function(){try{parseGIF(t,ee)}catch(e){q("parse")}},W=function(e,t){r.width=e*en(),r.height=t*en(),i.style.minWidth=e*en()+"px",o.width=e,o.height=t,o.style.width=e+"px",o.style.height=t+"px",o.getContext("2d").setTransform(1,0,0,1,0,0)},j=function(e,t){if(!_[e]){_[e]=t;return}void 0!==t.x&&(_[e].x=t.x),void 0!==t.y&&(_[e].y=t.y)},H=function(e,t,n){if(n&&O){var i,o,s,c,d=U;l.is_vp?v?(s=(l.vp_t+l.vp_h-d)/en(),d/=en(),o=(i=l.vp_l/en())+e/t*(l.vp_w/en()),c=r.width/en()):(s=l.vp_t+l.vp_h-d,o=(i=l.vp_l)+e/t*l.vp_w,c=r.width):(s=(r.height-d)/(v?en():1),o=e/t*r.width/(v?en():1),c=r.width/(v?en():1),d/=v?en():1),a.fillStyle=D,a.fillRect(o,s,c-o,d),a.fillStyle=G,a.fillRect(0,s,o,d)}},q=function(e){c=e,n={width:x.width,height:x.height},m=[],a.fillStyle="black",a.fillRect(0,0,l.c_w?l.c_w:n.width,l.c_h?l.c_h:n.height),a.strokeStyle="red",a.lineWidth=3,a.moveTo(0,0),a.lineTo(l.c_w?l.c_w:n.width,l.c_h?l.c_h:n.height),a.moveTo(0,l.c_h?l.c_h:n.height),a.lineTo(l.c_w?l.c_w:n.width,0),a.stroke()},L=function(e){W((n=e).width,n.height)},Z=function(e){J(),R(),h=e.transparencyGiven?e.transparencyIndex:null,u=e.delayTime,p=e.disposalMethod},J=function(){y&&(m.push({data:y.getImageData(0,0,n.width,n.height),delay:u}),_.push({x:0,y:0}))},K=function(e){y||(y=o.getContext("2d"));var t=m.length,r=e.lctFlag?e.lct:n.gct;t>0&&(3===g?null!==f?y.putImageData(m[f].data,0,0):y.clearRect($.leftPos,$.topPos,$.width,$.height):f=t-1,2===g&&y.clearRect($.leftPos,$.topPos,$.width,$.height));var i=y.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach(function(e,t){e!==h&&(i.data[4*t+0]=r[e][0],i.data[4*t+1]=r[e][1],i.data[4*t+2]=r[e][2],i.data[4*t+3]=255)}),y.putImageData(i,e.leftPos,e.topPos),v||(a.scale(en(),en()),v=!0),z&&(a.drawImage(o,0,0),z=l.auto_play),$=e},Q=(b=-1,T=0,B=function(e){b+=e,A()},k=(C=!1,P=function(){null!==F&&F(x),T++,!1!==N||T<0?S():(C=!1,w=!1)},S=function(){if(C=w){B(1);var e=10*m[b].delay;e||(e=100),0==(b+1+m.length)%m.length?setTimeout(P,e+=I):setTimeout(S,e)}},function(){C||setTimeout(S,0)}),A=function(){var e;(b=parseInt(b,10))>m.length-1&&(b=0),b<0&&(b=0),e=_[b],o.getContext("2d").putImageData(m[b].data,e.x,e.y),a.globalCompositeOperation="copy",a.drawImage(o,0,0)},E=function(){w=!0,k()},{init:function(){c||(l.c_w&&l.c_h||a.scale(en(),en()),l.auto_play?k():(b=0,A()))},step:k,play:E,pause:function(){w=!1},playing:w,move_relative:B,current_frame:function(){return b},length:function(){return m.length},move_to:function(e){b=e,A()}}),V=function(e){H(t.pos,t.data.length,e)},X=function(){},Y=function(e,t){return function(n){e(n),V(t)}},ee={hdr:Y(L),gce:Y(Z),com:Y(X),app:{NETSCAPE:Y(X)},img:Y(K,!0),eof:function(e){J(),V(!1),l.c_w&&l.c_h||(r.width=n.width*en(),r.height=n.height*en()),Q.init(),d=!1,ea&&ea(x)}},et=function(){var e=x.parentNode,t=document.createElement("div");a=(r=document.createElement("canvas")).getContext("2d"),i=document.createElement("div"),o=document.createElement("canvas"),t.width=r.width=x.width,t.height=r.height=x.height,i.style.minWidth=x.width+"px",t.className="jsgif",i.className="jsgif_toolbar",t.appendChild(r),t.appendChild(i),e.insertBefore(t,x),e.removeChild(x),l.c_w&&l.c_h&&W(l.c_w,l.c_h),er=!0},en=function(){var e;return l.max_width&&n&&n.width>l.max_width?l.max_width/n.width:1},er=!1,ea=!1,ei=function(e){return!d&&(ea=!!e&&e,d=!0,m=[],R(),f=null,g=null,y=null,$=null,!0)};return{play:Q.play,pause:Q.pause,move_relative:Q.move_relative,move_to:Q.move_to,get_playing:function(){return w},get_canvas:function(){return r},get_canvas_scale:function(){return en()},get_loading:function(){return d},get_auto_play:function(){return l.auto_play},get_length:function(){return Q.length()},get_current_frame:function(){return Q.current_frame()},load_url:function(e,n){if(ei(n)){var r=new XMLHttpRequest;r.open("GET",e,!0),"overrideMimeType"in r?r.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in r?r.responseType="arraybuffer":r.setRequestHeader("Accept-Charset","x-user-defined"),r.onloadstart=function(){er||et()},r.onload=function(e){200!=this.status&&q("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var n=this.response;n.toString().indexOf("ArrayBuffer")>0&&(n=new Uint8Array(n)),t=new Stream(n),setTimeout(M,0)},r.onprogress=function(e){e.lengthComputable&&H(e.loaded,e.total,!0)},r.onerror=function(){q("xhr")},r.send()}},load:function(e){this.load_url(x.getAttribute("rel:animated_src")||x.src,e)},load_raw:function(e,n){ei(n)&&(er||et(),t=new Stream(e),setTimeout(M,0))},set_frame_offset:j}};